@model IEnumerable<WebApplication1.Models.Student>

@{
    ViewData["Title"] = "Student List (Admin)";
}

<div class="admin-content-wrapper">
    <!-- Navigation Header -->
    <div class="nav-header-section">
        <div class="nav-title">
            <h2><i class="fas fa-user-graduate"></i> Student List (Admin)</h2>
        </div>
        <a asp-action="Create" asp-route-fromAdmin="true" class="nav-btn">
            <i class="fas fa-plus"></i>
            Create New Student
        </a>
    </div>

    <!-- Main Admin Card -->
    <div class="admin-card">
        <!-- Card Header -->
        <div class="admin-card-header">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="form-control search-input" 
                           placeholder="Search by name, course, or email..." 
                           oninput="filterStudentTable(this.value)" />
                </div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="table-card">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th><i class="fas fa-hashtag"></i> ID</th>
                        <th><i class="fas fa-user"></i> First Name</th>
                        <th><i class="fas fa-user"></i> Last Name</th>
                        <th><i class="fas fa-graduation-cap"></i> Course</th>
                        <th><i class="fas fa-envelope"></i> Email</th>
                        <th><i class="fas fa-cog"></i> Action</th>
                    </tr>
                </thead>
                <tbody>
            @foreach (var item in Model) {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.Id)</td>
                    <td>@Html.DisplayFor(modelItem => item.Firstname)</td>
                    <td>@Html.DisplayFor(modelItem => item.Lastname)</td>
                    <td>@Html.DisplayFor(modelItem => item.Course)</td>
                    <td>@Html.DisplayFor(modelItem => item.Email)</td>
                    <td>
                        <div class="action-buttons">
                            <a asp-action="Edit" asp-route-id="@item.Id" asp-route-fromAdmin="true" class="action-btn edit-btn">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form asp-action="Delete" asp-controller="Student" method="post" class="d-inline admin-action-form"
                                  data-confirm="Are you sure you want to delete this student?">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <button type="submit" class="action-btn delete-btn">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="pagination-wrapper" id="studentPagination">
        <ul class="custom-pagination">
            @if (ViewBag.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link page-nav-link" href="@Url.Action("AdminList", "Student", new { page = ViewBag.CurrentPage - 1 })" data-page="@(ViewBag.CurrentPage - 1)">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                </li>
            }
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                    <a class="page-link page-nav-link" href="@Url.Action("AdminList", "Student", new { page = i })" data-page="@i">@i</a>
                </li>
            }
            @if (ViewBag.CurrentPage < ViewBag.TotalPages)
            {
                <li class="page-item">
                    <a class="page-link page-nav-link" href="@Url.Action("AdminList", "Student", new { page = ViewBag.CurrentPage + 1 })" data-page="@(ViewBag.CurrentPage + 1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            }
        </ul>
    </nav>
</div>

<script>
    // Track all students data for client-side search
    var allStudentsData = [];
    
    // Intercept pagination clicks to prevent navigation
    setTimeout(function() {
        const paginationLinks = document.querySelectorAll('.page-nav-link');
        paginationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pageNum = this.getAttribute('data-page');
                loadStudentPage(pageNum);
            });
        });
    }, 100);
    
    function loadStudentPage(page) {
        const container = document.querySelector('.admin-card');
        if (!container) return;
        
        // Show loading
        container.style.opacity = '0.6';
        
        fetch('/Student/AdminList?page=' + page, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            // Parse and extract the admin card content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCard = doc.querySelector('.admin-card');
            const newPagination = doc.querySelector('.pagination-wrapper');
            
            if (newCard) {
                container.innerHTML = newCard.innerHTML;
            }
            
            // Re-add pagination if it exists
            if (newPagination) {
                const oldPagination = document.querySelector('.pagination-wrapper');
                if (oldPagination && oldPagination.parentNode) {
                    oldPagination.parentNode.replaceChild(newPagination.cloneNode(true), oldPagination);
                }
            }
            
            container.style.opacity = '1';
            
            // Re-attach pagination listeners
            setTimeout(function() {
                const paginationLinks = document.querySelectorAll('.page-nav-link');
                paginationLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const pageNum = this.getAttribute('data-page');
                        loadStudentPage(pageNum);
                    });
                });
            }, 100);
            
            // Re-execute search script
            const scripts = document.querySelectorAll('.admin-card script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        })
        .catch(err => {
            console.error('Error loading page:', err);
            container.style.opacity = '1';
        });
    }
    
    // Define the search filter function globally so oninput can call it
    function filterStudentTable(searchText) {
        console.log('Filter called with:', searchText);
        searchText = searchText.toLowerCase().trim();
        
        if (!searchText) {
            // If no search text, show pagination and current page only
            showPaginationView();
            return;
        }
        
        // When searching, fetch all students and display filtered results
        fetchAllStudentsAndFilter(searchText);
    }
    
    function showPaginationView() {
        const tableRows = document.querySelectorAll('.admin-table tbody tr');
        const pagination = document.querySelector('.pagination-wrapper');
        
        // Show all rows (server already paginated them)
        tableRows.forEach(row => {
            row.style.display = '';
        });
        
        // Show pagination
        if (pagination) {
            pagination.style.display = '';
        }
    }
    
    function fetchAllStudentsAndFilter(searchText) {
        const tbody = document.querySelector('.admin-table tbody');
        const pagination = document.querySelector('.pagination-wrapper');
        
        if (!tbody) return;
        
        // Hide pagination during search
        if (pagination) {
            pagination.style.display = 'none';
        }
        
        // Fetch all students from server
        fetch('/Student/AdminList?page=1&pageSize=1000', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract all student rows
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const allRows = doc.querySelectorAll('.admin-table tbody tr');
            
            // Clear current tbody
            tbody.innerHTML = '';
            
            // Filter and add matching rows
            let matchCount = 0;
            allRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchText)) {
                    tbody.appendChild(row.cloneNode(true));
                    matchCount++;
                }
            });
            
            // Show message if no results
            if (matchCount === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 2rem;">No students found matching "' + searchText + '"</td></tr>';
            }
            
            console.log('Filtered results:', matchCount);
        })
        .catch(err => {
            console.error('Error fetching students:', err);
        });
    }
    
    // Also add event listener as backup
    setTimeout(function() {
        const input = document.getElementById('searchInput');
        if (input) {
            console.log('Found input, adding listener');
            input.addEventListener('keyup', function(e) {
                console.log('Keyup event:', e.target.value);
                filterStudentTable(e.target.value);
            });
        } else {
            console.log('Input not found');
        }
    }, 100);
</script>

<style>
    /* Main Container */
    .admin-content-wrapper {
        padding: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    /* Navigation Header */
    .nav-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        gap: 2rem;
    }

    .nav-title {
        flex: 1;
        text-align: center;
    }

    .nav-title h2 {
        margin: 0;
        color: #1a237e;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .nav-title h2 i {
        color: #667eea;
    }

    .nav-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        color: white;
    }

    /* Admin Card */
    .admin-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .admin-card-header {
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-bottom: 3px solid #764ba2;
    }

    /* Search Container */
    .search-container {
        max-width: 100%;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 1.2rem;
        color: #667eea;
        font-size: 1.1rem;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 0.9rem 1rem 0.9rem 3rem;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Table Card */
    .table-card {
        background: white;
    }

    /* Admin Table Styling */
    .admin-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
    }

    .admin-table thead tr {
        background: linear-gradient(135deg, #1a237e 0%, #2c3e82 100%);
        color: white;
    }

    .admin-table th {
        padding: 1.2rem 1rem;
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
        font-size: 0.95rem;
    }

    .admin-table th i {
        margin-right: 0.5rem;
        opacity: 0.9;
    }

    .admin-table td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .admin-table tbody tr {
        transition: all 0.3s ease;
    }

    .admin-table tbody tr:hover {
        background-color: #f8f9ff;
        transform: scale(1.005);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .admin-action-form {
        display: inline;
        margin: 0;
    }

    .action-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .edit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .delete-btn {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        color: white;
    }

    /* Pagination */
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }

    .custom-pagination {
        display: flex;
        list-style: none;
        gap: 0.5rem;
        padding: 0;
        margin: 0;
    }

    .custom-pagination .page-item {
        list-style: none;
    }

    .custom-pagination .page-link {
        padding: 0.7rem 1.2rem;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .custom-pagination .page-link:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .custom-pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #764ba2;
    }

    @@media (max-width: 768px) {
        .nav-header-section {
            flex-direction: column;
            gap: 1rem;
        }

        .admin-content-wrapper {
            padding: 1rem;
        }

        .admin-table {
            font-size: 0.85rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 0.75rem 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .custom-pagination {
            flex-wrap: wrap;
            justify-content: center;
        }
    }
</style>
