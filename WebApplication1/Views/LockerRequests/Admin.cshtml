@model IEnumerable<WebApplication1.Models.LockerRequest>
@{
    ViewData["Title"] = "Admin - Locker Requests";
}

<div class="admin-content-wrapper">
    <div class="nav-header-section">
        <button id="prevPanelBtn" class="nav-btn">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <div class="nav-title">
            <h2><i class="fas fa-clipboard-list"></i> View More Forms</h2>
        </div>
        <button id="nextPanelBtn" class="nav-btn">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- container where other admin tables (LockerRequests / Reservation / Student) will be loaded -->
    <div id="adminPanelsContainer" class="mt-3">
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-title">
                    <i class="fas fa-key"></i> Admin - Locker Requests
                </h2>
            </div>
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchLockerInput" class="form-control search-input" 
                           placeholder="Search by name, ID, semester, or contact..." 
                           oninput="filterLockerTable(this.value)" />
                </div>
            </div>
            <div class="table-card">
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> #</th>
                                <th><i class="fas fa-user"></i> Name</th>
                                <th><i class="fas fa-id-card"></i> ID</th>
                                <th><i class="fas fa-lock"></i> Locker</th>
                                <th><i class="fas fa-calendar-alt"></i> Semester</th>
                                <th><i class="fas fa-phone"></i> Contact</th>
                                <th><i class="fas fa-file-alt"></i> File</th>
                                <th><i class="fas fa-info-circle"></i> Status</th>
                                <th><i class="fas fa-cog"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                                    @{int counter = 1;}
                                    @foreach (var r in Model)
                                    {
                                        <tr>
                                            <td>@(counter++)</td>
                                            <td>@r.Name</td>
                                            <td>@r.IdNumber</td>
                                            <td>@r.LockerNumber</td>
                                            <td>@r.Semester</td>
                                            <td>@r.ContactNumber</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(r.RegistrationFilePath))
                                                {
                                                    <a href="@r.RegistrationFilePath" target="_blank">View</a>
                                                }
                                            </td>
                                            <td>
                                                @{
                                                    var status = r.Approved == null ? "Pending" : r.Approved == true ? "Approved" : "Rejected";
                                                    var approver = !string.IsNullOrEmpty(r.Approver) && r.Approver != "Pending" ? $"by {r.Approver}" : "";
                                                }
                                                <span class="status-badge @(status == "Approved" ? "approved" : status == "Rejected" ? "rejected" : "pending")">
                                                    @status
                                                </span>
                                                @if (!string.IsNullOrEmpty(approver))
                                                {
                                                    <br />
                                                    <small class="text-muted">@approver</small>
                                                }
                                            </td>
                                            <td style="white-space:nowrap;">
                                                <form class="admin-action-form" asp-action="Approve" method="post" style="display:inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <input type="hidden" name="approve" value="true" />
                                                    <button type="submit" class="action-btn approve-btn">Approve</button>
                                                </form>

                                                <form class="admin-action-form" asp-action="Approve" method="post" style="display:inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <input type="hidden" name="approve" value="false" />
                                                    <button type="submit" class="action-btn reject-btn">Reject</button>
                                                </form>

                                                <form class="admin-action-form" asp-action="Delete" method="post" style="display:inline" data-confirm="Are you sure you want to delete this request?">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@r.Id" />
                                                    <button type="submit" class="action-btn" style="background-color: #6c757d; color: white;">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <nav aria-label="Page navigation" class="d-flex justify-content-center mt-3">
                                <ul class="pagination">
                                    @if (ViewBag.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = ViewBag.CurrentPage - 1 })">&laquo;</a>
                                        </li>
                                    }
                                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                    {
                                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = i })">@i</a>
                                        </li>
                                    }
                                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link admin-page-link" href="@Url.Action("Admin", "LockerRequests", new { page = ViewBag.CurrentPage + 1 })">&raquo;</a>
                                        </li>
                                    }
                                </ul>
                            </nav>

                        </div> <!-- /.table-responsive -->
                    </div> <!-- /.table-card -->
                </div> <!-- /.admin-card -->
            </div> <!-- /#adminPanelsContainer -->

</div> <!-- /.admin-content-wrapper -->

@section Scripts {
    <script>
        // Define the search filter function globally for locker requests
        function filterLockerTable(searchText) {
            console.log('Filter locker called with:', searchText);
            searchText = searchText.toLowerCase().trim();
            
            if (!searchText) {
                // If no search text, show pagination and current page only
                showLockerPaginationView();
                return;
            }
            
            // When searching, fetch all locker requests and display filtered results
            fetchAllLockersAndFilter(searchText);
        }
        
        function showLockerPaginationView() {
            const tableRows = document.querySelectorAll('.admin-table tbody tr');
            const pagination = document.querySelector('nav[aria-label="Page navigation"]');
            
            // Show all rows (server already paginated them)
            tableRows.forEach(row => {
                row.style.display = '';
            });
            
            // Show pagination
            if (pagination) {
                pagination.style.display = '';
            }
        }
        
        function fetchAllLockersAndFilter(searchText) {
            const tbody = document.querySelector('.admin-table tbody');
            const pagination = document.querySelector('nav[aria-label="Page navigation"]');
            
            if (!tbody) return;
            
            // Hide pagination during search
            if (pagination) {
                pagination.style.display = 'none';
            }
            
            // Fetch all locker requests from server
            fetch('/LockerRequests/Admin?page=1&pageSize=1000', {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the HTML to extract all locker request rows
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const allRows = doc.querySelectorAll('.admin-table tbody tr');
                
                // Clear current tbody
                tbody.innerHTML = '';
                
                // Filter and add matching rows
                let matchCount = 0;
                allRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchText)) {
                        tbody.appendChild(row.cloneNode(true));
                        matchCount++;
                    }
                });
                
                // Show message if no results
                if (matchCount === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="padding: 2rem;">No locker requests found matching "' + searchText + '"</td></tr>';
                }
                
                console.log('Filtered locker results:', matchCount);
            })
            .catch(err => {
                console.error('Error fetching locker requests:', err);
            });
        }

        (function(){
            const prevBtn = document.getElementById('prevPanelBtn');
            const nextBtn = document.getElementById('nextPanelBtn');
            const container = document.getElementById('adminPanelsContainer');

            // capture the current locker requests card HTML so we can restore it
            const adminCard = container.querySelector('.admin-card');
            const originalHtml = adminCard ? adminCard.outerHTML : '';

            const panels = [
                { type: 'html', content: originalHtml },
                { type: 'url', url: '/Reservation/AdminList' },
                { type: 'url', url: '/Student/AdminList' },
                { type: 'url', url: '/GatePass/AdminList' }
            ];

            // intercept pagination links inside injected panels and load via AJAX
            container.addEventListener('click', function(e){
                const a = e.target.closest && e.target.closest('a.admin-page-link');
                if (!a) return;
                e.preventDefault();
                const url = a.getAttribute('href');
                fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(r => { if (!r.ok) throw new Error(r.status); return r.text(); })
                    .then(html => setPanelHtml(html))
                    .catch(err => setPanelHtml('<div class="alert alert-danger">Error loading page: ' + err.message + '</div>'));
            });

            // intercept admin action form submissions (Approve/Reject/Delete) and perform via AJAX
            container.addEventListener('submit', function(e){
                const form = e.target.closest && e.target.closest('form.admin-action-form');
                if (!form) return;
                e.preventDefault();

                // If a data-confirm attribute exists, show confirmation
                const confirmMsg = form.getAttribute('data-confirm');
                if (confirmMsg && !window.confirm(confirmMsg)) return;

                const action = form.getAttribute('action') || window.location.href;
                const method = (form.getAttribute('method') || 'POST').toUpperCase();
                const formData = new FormData(form);

                // Show loading state
                container.style.opacity = '0.6';

                fetch(action, { 
                    method, 
                    credentials: 'same-origin', 
                    body: formData, 
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(r => {
                        if (!r.ok) throw new Error(r.statusText || r.status);
                        return r.text();
                    })
                    .then(html => {
                        // Display the returned HTML immediately
                        setPanelHtml(html);
                    })
                    .catch(err => {
                        container.style.opacity = '1';
                        alert('Action failed: ' + err.message);
                    });
            });

            let idx = 0; // currently showing locker requests (index 0)

            function setPanelHtml(html){
                // fade out
                container.classList.add('fade-out');
                container.style.opacity = '0.6';
                setTimeout(() => {
                    try {
                        // Parse the returned HTML and try to extract only the inner admin panel
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var extracted = doc.getElementById('adminPanelsContainer');
                        if (extracted) {
                            // Insert only the inner content to avoid duplicating outer controls
                            container.innerHTML = extracted.innerHTML;
                        } else {
                            // Fallback: server returned a fragment already
                            container.innerHTML = html;
                        }
                    } catch (e) {
                        // If parsing fails, fallback to raw HTML
                        container.innerHTML = html;
                    }

                    container.classList.remove('fade-out');
                    container.classList.add('fade-in');
                    container.style.opacity = '1';
                    // remove fade-in class after animation so it can be reused
                    setTimeout(() => {
                        container.classList.remove('fade-in');
                        
                        // Re-execute any inline scripts in the loaded content
                        const scripts = container.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            if (oldScript.src) {
                                newScript.src = oldScript.src;
                            } else {
                                newScript.textContent = oldScript.textContent;
                            }
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }, 350);
                }, 300);
            }

            async function loadPanel(panel){
                if (panel.type === 'html'){
                    setPanelHtml(panel.content);
                    return;
                }
                try{
                    const res = await fetch(panel.url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (!res.ok) throw new Error('Failed to load: ' + res.status);
                    const text = await res.text();
                    setPanelHtml(text);
                } catch (err){
                    setPanelHtml('<div class="alert alert-danger">Error loading panel: ' + err.message + '</div>');
                }
            }

            nextBtn.addEventListener('click', function(){
                idx = (idx + 1) % panels.length;
                loadPanel(panels[idx]);
            });

            prevBtn.addEventListener('click', function(){
                idx = (idx - 1 + panels.length) % panels.length;
                loadPanel(panels[idx]);
            });

        })();
    </script>
}

<style>
    /* Main Container */
    .admin-content-wrapper {
        padding: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    /* Navigation Header */
    .nav-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        gap: 2rem;
    }

    .nav-title {
        flex: 1;
        text-align: center;
    }

    .nav-title h2 {
        margin: 0;
        color: #1a237e;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .nav-title h2 i {
        color: #667eea;
    }

    .nav-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    /* Admin Card */
    .admin-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .admin-card-header {
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-bottom: 3px solid #764ba2;
    }

    /* Search Container */
    .search-container {
        padding: 1.5rem 2rem;
        background: white;
        border-bottom: 1px solid #e2e8f0;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 1.2rem;
        color: #667eea;
        font-size: 1.1rem;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 0.9rem 1rem 0.9rem 3rem;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .admin-title {
        margin: 0;
        color: white;
        font-size: 1.8rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* Table Card */
    .table-card {
        background: white;
    }

    /* Admin Table Styling */
    .admin-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
    }

    .admin-table thead tr {
        background: linear-gradient(135deg, #1a237e 0%, #2c3e82 100%);
        color: white;
    }

    .admin-table th {
        padding: 1.2rem 1rem;
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
        font-size: 0.95rem;
    }

    .admin-table th i {
        margin-right: 0.5rem;
        opacity: 0.9;
    }

    .admin-table td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .admin-table tbody tr {
        transition: all 0.3s ease;
    }

    .admin-table tbody tr:hover {
        background-color: #f8f9ff;
        transform: scale(1.005);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }

    /* Status Badges */
    .status-badge {
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .status-badge.pending {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        color: #000;
    }

    .status-badge.approved {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .status-badge.rejected {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
    }

    /* Action Buttons */
    .action-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 0.25rem;
        font-size: 0.85rem;
    }

    .approve-btn {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .reject-btn {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
    }

    .delete-btn {
        background: linear-gradient(135deg, #757f9a 0%, #d7dde8 100%);
        color: #333;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Animations */
    .fade-out {
        opacity: 0;
        transition: opacity 300ms ease;
    }

    .fade-in {
        opacity: 1;
        transition: opacity 300ms ease;
    }

    @@media (max-width: 768px) {
        .nav-header-section {
            flex-direction: column;
            gap: 1rem;
        }

        .admin-content-wrapper {
            padding: 1rem;
        }

        .admin-table {
            font-size: 0.85rem;
        }

        .admin-table th,
        .admin-table td {
            padding: 0.75rem 0.5rem;
        }
    }
</style>
